# GM6020角度控制

作者：**刘煜川**		日期：**2021.11.27**

## 目的

使用双环PID实现GM6020速度闭环控制

使用三环PID实现GM6020角度闭环控制

## 双环速度控制

### 概念

在GM6020速度控制实验中，我们使用单环PID实现了速度闭环控制，**单环速度控制**框图如下：

![image-20211127141317893](GM6020角度控制.assets/image-20211127141317893.png)

可以看出，电压到转速经过了两步：先是电压作用在线圈产生电流，然后电流产生的力矩使得电机转动。

那么如果能增加对电流这个中间量的控制，就能获得更好的控制效果。

相当于把原本复杂的系统——电压到转速，拆分成两个更简单的步骤——电压到电流、电流到转速。

单个PID控制能更好地适用于低阶的系统，复杂系统通常会用多个PID串联实现。

如下框图为**双环速度控制**：

![image-20211127141509849](GM6020角度控制.assets/image-20211127141509849.png)

- 内环是电流环，电流环的输出是给电机的设定电压，电流环要实现电流的控制，就是让实际电流尽可能接近预期电流。
- 外环是速度环，速度环的输出是预期电流，速度环要实现速度的控制，就是让实际转速尽可能接近预期转速。

注意，因为GM6020电机具有电流传感器，才使得我们可以实现电流闭环。

### 过程

继续使用上个实验转速控制的工程

增加电流环PID，将所有PID的参数清零，考虑一下输出限幅，速度环PID输出量为预期电流，所以限幅应该是最大电流，电流环PID输出量为设定电压，所以限幅应该是最大电压，这两个量的范围都是-30000到30000左右，所以都可以采用TestMotor.MAX_CURRENT()。

![image-20211127150218597](GM6020角度控制.assets/image-20211127150218597.png)

按照上面框图的输入输出关系写一下PID计算过程先算速度环，后算电流环

![image-20211127151545472](GM6020角度控制.assets/image-20211127151545472.png)

增加一下需要调试的参数，和需要显示的参数

![image-20211127152439762](GM6020角度控制.assets/image-20211127152439762.png)

编译，下载，修改一下通道数

![image-20211127152134696](GM6020角度控制.assets/image-20211127152134696.png)

修改下命名

![image-20211127152235236](GM6020角度控制.assets/image-20211127152235236.png)

调参从内环电流环开始，因为只有内环工作良好，外环才可能工作良好。但是电流环的输入是预期电流，是转速环给出的，所以需要先给转速环一个不大的参数p来产生一个预期电流。

转动电机看一下电流典型值1000左右，转速典型值20，速度环p可以取1000/20=50。

![image-20211127153252174](GM6020角度控制.assets/image-20211127153252174.png)

给一个20的预期转速，此时可以看到预期电流为1000，下面开始调电流环参数，选择显示的曲线为电流和预期电流

![image-20211127161249035](GM6020角度控制.assets/image-20211127161249035.png)

因为电流和电压的典型值接近，所以p可以先取0.5

![image-20211127161754111](GM6020角度控制.assets/image-20211127161754111.png)

实际电流和预期电流有比较大的稳态误差，尝试增加p试一下，当增大到4左右，出现了不期望的高频震荡，所以最终可以取2左右

![image-20211127162002567](GM6020角度控制.assets/image-20211127162002567.png)

下面加入i来消除稳态误差，不确定数量级，先取p的万分之1，观察到收敛，不过比较慢，增大调一下

![image-20211127162407342](GM6020角度控制.assets/image-20211127162407342.png)

修改参数后，也要修改预期转速，来观察响应情况，我这里是以40和-40的跳变来观察的，最终参数p=2,i=0.01，电流跟踪良好

![image-20211127162726504](GM6020角度控制.assets/image-20211127162726504.png)

下面来调速度环，显示的曲线改成速度和预期速度，p增加到100，跳变是有些震荡，需要离100远一点，还是取50

![image-20211127163141926](GM6020角度控制.assets/image-20211127163141926.png)

然后尝试一下调i，最终选定p=50，i=0.2，跟踪良好

![image-20211127164537024](GM6020角度控制.assets/image-20211127164537024.png)

记下参数

![image-20211127165136933](GM6020角度控制.assets/image-20211127165136933.png)

## 三环角度控制

### 概念

在速度控制完成以后，可以继续实现角度控制，将上文的整体作为内环，外加角度环，就可以实现角度控制。内环几乎不用改变，包括参数。

如下框图为**三环角度控制**：

![image-20211127141542443](GM6020角度控制.assets/image-20211127141542443.png)

预期转速不再由使用者提供，而是角度环的输出。

### 过程

增加角度环PID，参数初始化为0，积分限幅和输出限幅是最大预期速度，为测试安全可取100。内环的参数不需要修改，可以直接用。

![image-20211127170004297](GM6020角度控制.assets/image-20211127170004297.png)

增加角度环PID计算过程

![image-20211127170321166](GM6020角度控制.assets/image-20211127170321166.png)

需要修改的预期量改为角度，增加另外几个新变量

![image-20211127170621414](GM6020角度控制.assets/image-20211127170621414.png)

串口绘图增加一个通道，开始调角度环参数，角度值单位是度，预期角度给个90度

![image-20211127171046899](GM6020角度控制.assets/image-20211127171046899.png)

转速典型值40，那么角度环p可取0.5

![image-20211127171639316](GM6020角度控制.assets/image-20211127171639316.png)

观察角度和预期角度，收敛比较慢，p不够大

![image-20211127171735875](GM6020角度控制.assets/image-20211127171735875.png)

调整几次增加p到20，此时角度曲线的前段已经是一条直线了，我们打开转速曲线看一下，转速已经达到了我们设定的最大转速100附近了，在我们设定的这个条件下已经没法更快了。因为现在电机没有负载，所以转速很容易上去。

![image-20211128150207557](GM6020角度控制.assets/image-20211128150207557.png)

但这样达到边界值的曲线是没法调参，可以把输入给的小一点，比如角度10。

![image-20211128151156084](GM6020角度控制.assets/image-20211128151156084.png)

放大看一下，完全收敛的时间0.13s，基本可以了，角度环通常不需要积分项

![image-20211128151423243](GM6020角度控制.assets/image-20211128151423243.png)

最终参数

![image-20211128151947507](GM6020角度控制.assets/image-20211128151947507.png)

由于电机是工作在空载状态下，整体的惯性很小，响应很快，很多参数的作用并不明显。

## 后记

### 为什么用阶跃响应

​		我们在调参是总是使用阶跃信号作为输入，观察输出的跟随情况，因为这是一个典型的信号，有几个典型的指标可以衡量好坏：超调量、收敛时间、稳态误差。但是并不是什么时候都能用阶跃响应的，比如我们调俯仰云台的时候，它并不能朝一个方向一直转，就意味着速度环不好用阶跃响应法，这时候可能就要角度环和速度环一起调了。实际上上文双环控制那里的电流环和速度环就是一起调的，并没有先单独调电流环。

​		但在系统参数整定好投入使用的时候，我们通常并不希望输入的控制量是阶跃的，而应该是平滑的，比如战车的云台、底盘的输入是来自遥控器的，就是一个平滑的输入。

### 控制频率

​		PID计算频率、电机数据回传频率、给电机发送控制信号的频率都是1kHz，但是串口绘图的频率是100Hz（受限于115200的波特率），这意味着某些高频的、突发的信号可能显示不出来，如果需要显示1kHz的数据，需要提高一下串口波特率。

